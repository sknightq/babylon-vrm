(function(h,P){typeof exports=="object"&&typeof module!="undefined"?P(exports,require("@babylonjs/core"),require("@babylonjs/loaders/glTF/2.0"),require("@babylonjs/loaders/glTF/glTFFileLoader")):typeof define=="function"&&define.amd?define(["exports","@babylonjs/core","@babylonjs/loaders/glTF/2.0","@babylonjs/loaders/glTF/glTFFileLoader"],P):(h=typeof globalThis!="undefined"?globalThis:h||self,P(h["babylon-vrm"]={},h.BABYLON,h.GLTFL2,h.FileLoader))})(this,function(h,P,ft,pt){"use strict";function ut(i){if(i&&i.__esModule)return i;var t={__proto__:null,[Symbol.toStringTag]:"Module"};return i&&Object.keys(i).forEach(function(e){if(e!=="default"){var r=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(t,e,r.get?r:{enumerable:!0,get:function(){return i[e]}})}}),t.default=i,Object.freeze(t)}var n=ut(P);function E(i,t){t(i);const e=i.getChildren();for(let r=0;r<e.length;r++)E(e[r],t)}function dt(i,t,e){const r=n.Vector3.Dot(i,t)+1;return r<n.Epsilon?Math.abs(i.x)>Math.abs(i.z)?e.set(-i.y,i.x,0,0):e.set(0,-i.z,i.y,0):(n.Vector3.CrossToRef(i,t,n.TmpVectors.Vector3[0]),e.set(n.TmpVectors.Vector3[0].x,n.TmpVectors.Vector3[0].y,n.TmpVectors.Vector3[0].z,r)),e.normalize()}function F(i,t,e){const r=t.x,o=t.y,a=t.z,s=i.x,l=i.y,c=i.z,f=i.w,u=f*r+l*a-c*o,d=f*o+c*r-s*a,p=f*a+s*o-l*r,g=-s*r-l*o-c*a;e.x=u*f+g*-s+d*-c-p*-l,e.y=d*f+g*-l+p*-s-u*-c,e.z=p*f+g*-c+u*-l-d*-s}function N(i){Object.keys(i).forEach(t=>{const e=i[t];(e==null?void 0:e.isTexture)&&e.dispose()}),i.dispose()}function gt(i){const t=i.geometry;t&&t.dispose();const e=i.material;e&&(Array.isArray(e)?e.forEach(r=>N(r)):e&&N(e))}function yt(i){E(i,gt)}function _t(i){return i[0]!=="_"?(console.warn(`renameMaterialProperty: Given property name "${i}" might be invalid`),i):(i=i.substring(1),/[A-Z]/.test(i[0])?i[0].toLowerCase()+i.substring(1):(console.warn(`renameMaterialProperty: Given property name "${i}" might be invalid`),i))}h.VRMSchema=void 0,(i=>{(t=>{t.A="a",t.Angry="angry",t.Blink="blink",t.BlinkL="blink_l",t.BlinkR="blink_r",t.E="e",t.Fun="fun",t.I="i",t.Joy="joy",t.Lookdown="lookdown",t.Lookleft="lookleft",t.Lookright="lookright",t.Lookup="lookup",t.Neutral="neutral",t.O="o",t.Sorrow="sorrow",t.U="u",t.Unknown="unknown"})(i.ExpressionPresetName||(i.ExpressionPresetName={})),(t=>{t.Expression="Expression",t.Bone="Bone"})(i.FirstPersonLookAtTypeName||(i.FirstPersonLookAtTypeName={})),(t=>{t.Chest="chest",t.Head="head",t.Hips="hips",t.Jaw="jaw",t.LeftEye="leftEye",t.LeftFoot="leftFoot",t.LeftHand="leftHand",t.LeftIndexDistal="leftIndexDistal",t.LeftIndexIntermediate="leftIndexIntermediate",t.LeftIndexProximal="leftIndexProximal",t.LeftLittleDistal="leftLittleDistal",t.LeftLittleIntermediate="leftLittleIntermediate",t.LeftLittleProximal="leftLittleProximal",t.LeftLowerArm="leftLowerArm",t.LeftLowerLeg="leftLowerLeg",t.LeftMiddleDistal="leftMiddleDistal",t.LeftMiddleIntermediate="leftMiddleIntermediate",t.LeftMiddleProximal="leftMiddleProximal",t.LeftRingDistal="leftRingDistal",t.LeftRingIntermediate="leftRingIntermediate",t.LeftRingProximal="leftRingProximal",t.LeftShoulder="leftShoulder",t.LeftThumbDistal="leftThumbDistal",t.LeftThumbIntermediate="leftThumbIntermediate",t.LeftThumbProximal="leftThumbProximal",t.LeftToes="leftToes",t.LeftUpperArm="leftUpperArm",t.LeftUpperLeg="leftUpperLeg",t.Neck="neck",t.RightEye="rightEye",t.RightFoot="rightFoot",t.RightHand="rightHand",t.RightIndexDistal="rightIndexDistal",t.RightIndexIntermediate="rightIndexIntermediate",t.RightIndexProximal="rightIndexProximal",t.RightLittleDistal="rightLittleDistal",t.RightLittleIntermediate="rightLittleIntermediate",t.RightLittleProximal="rightLittleProximal",t.RightLowerArm="rightLowerArm",t.RightLowerLeg="rightLowerLeg",t.RightMiddleDistal="rightMiddleDistal",t.RightMiddleIntermediate="rightMiddleIntermediate",t.RightMiddleProximal="rightMiddleProximal",t.RightRingDistal="rightRingDistal",t.RightRingIntermediate="rightRingIntermediate",t.RightRingProximal="rightRingProximal",t.RightShoulder="rightShoulder",t.RightThumbDistal="rightThumbDistal",t.RightThumbIntermediate="rightThumbIntermediate",t.RightThumbProximal="rightThumbProximal",t.RightToes="rightToes",t.RightUpperArm="rightUpperArm",t.RightUpperLeg="rightUpperLeg",t.Spine="spine",t.UpperChest="upperChest"})(i.HumanoidBoneName||(i.HumanoidBoneName={})),(t=>{t.Everyone="Everyone",t.ExplicitlyLicensedPerson="ExplicitlyLicensedPerson",t.OnlyAuthor="OnlyAuthor"})(i.MetaAllowedUserName||(i.MetaAllowedUserName={})),(t=>{t.Allow="Allow",t.Disallow="Disallow"})(i.MetaUssageName||(i.MetaUssageName={})),(t=>{t.Cc0="CC0",t.CcBy="CC_BY",t.CcByNc="CC_BY_NC",t.CcByNcNd="CC_BY_NC_ND",t.CcByNcSa="CC_BY_NC_SA",t.CcByNd="CC_BY_ND",t.CcBySa="CC_BY_SA",t.Other="Other",t.RedistributionProhibited="Redistribution_Prohibited"})(i.MetaLicenseName||(i.MetaLicenseName={}))})(h.VRMSchema||(h.VRMSchema={}));function Q(i,t,e){const o=i.gltf.nodes[t].mesh;if(o==null)return null;const s=i.gltf.meshes[o].primitives.length,l=[];return E(e._babylonTransformNode,c=>{l.length<s&&c._isMesh&&l.push(c)}),l}async function Y(i,t){const e=i.gltf.nodes[t];return Q(i,t,e)}async function mt(i){const t=i.gltf.nodes,e=new Map;return t.forEach((r,o)=>{const a=Q(i,o,r);a!=null&&e.set(o,a)}),e}const xt=new n.Vector2,Tt=new n.Vector3,Pt=new n.Quaternion,wt=new n.Color3;class j extends n.TransformNode{constructor(t){super(`${t}`);this.weight=0,this.isBinary=!1,this._binds=[],this._materialValues=[],this.name=`ExpressionController_${t}`,this.type="ExpressionController",this.setEnabled(!1)}addBind(t){const e=t.weight/100;this._binds.push({meshes:t.meshes,morphTargetIndex:t.morphTargetIndex,weight:e})}addMaterialValue(t){const e=t.material,r=t.propertyName;let o=e[r];if(!o)return;o=t.defaultValue||o;let a,s,l,c;o.isVector2?(a=1,s=o.clone(),l=new n.Vector2().fromArray(t.targetValue),c=l.clone().subtract(s)):o.isVector3?(a=2,s=o.clone(),l=new n.Vector3().fromArray(t.targetValue),c=l.clone().subtract(s)):o.isVector4?(a=3,s=o.clone(),l=n.Quaternion.FromArray([t.targetValue[2],t.targetValue[3],t.targetValue[0],t.targetValue[1]]),c=l.clone().subtract(s)):o.isColor?(a=4,s=o.clone(),l=new n.Color3().fromArray(t.targetValue),c=l.clone().subtract(s)):(a=0,s=o,l=t.targetValue[0],c=l-s),this._materialValues.push({material:e,propertyName:r,defaultValue:s,targetValue:l,deltaValue:c,type:a})}applyWeight(){const t=this.isBinary?this.weight<.5?0:1:this.weight;this._binds.forEach(e=>{e.meshes.forEach(r=>{const o=r.morphTargetManager;!o||(o.getTarget(e.morphTargetIndex).influence+=t*e.weight)})}),this._materialValues.forEach(e=>{if(e.material[e.propertyName]!==void 0){if(e.type===0){const o=e.deltaValue;e.material[e.propertyName]+=o*t}else if(e.type===1){const o=e.deltaValue;e.material[e.propertyName].add(xt.copyFrom(o).multiplyByFloats(t,t))}else if(e.type===2){const o=e.deltaValue;e.material[e.propertyName].add(Tt.copyFrom(o).multiplyByFloats(t,t,t))}else if(e.type===3){const o=n.Quaternion.FromArray([e.deltaValue[0]*t,e.deltaValue[1]*t,e.deltaValue[2]*t,e.deltaValue[3]*t]);e.material[e.propertyName].add(Pt.copyFrom(o))}else if(e.type===4){const o=n.Color3.FromArray([e.deltaValue[0]*t,e.deltaValue[1]*t,e.deltaValue[2]*t]);e.material[e.propertyName].add(wt.copyFrom(o))}typeof e.material.shouldApplyUniforms=="boolean"&&(e.material.shouldApplyUniforms=!0)}})}clearAppliedWeight(){this._binds.forEach(t=>{t.meshes.forEach(e=>{const r=e.morphTargetManager;!r||(r.getTarget(t.morphTargetIndex).influence=0)})}),this._materialValues.forEach(t=>{if(t.material[t.propertyName]!==void 0){if(t.type===0){const r=t.defaultValue;t.material[t.propertyName]=r}else if(t.type===1){const r=t.defaultValue;t.material[t.propertyName].copy(r)}else if(t.type===2){const r=t.defaultValue;t.material[t.propertyName].copy(r)}else if(t.type===3){const r=t.defaultValue;t.material[t.propertyName].copy(r)}else if(t.type===4){const r=t.defaultValue;t.material[t.propertyName].copy(r)}typeof t.material.shouldApplyUniforms=="boolean"&&(t.material.shouldApplyUniforms=!0)}})}}class G{constructor(){this._expressionGroups={},this._expressionPresetMap={},this._unknownGroupNames=[]}get expressions(){return Object.keys(this._expressionGroups)}get expressionPresetMap(){return this._expressionPresetMap}get unknownGroupNames(){return this._unknownGroupNames}getExpressionGroup(t){const e=this._expressionPresetMap[t],r=e?this._expressionGroups[e]:this._expressionGroups[t];if(!r){console.warn(`no expression found by ${t}`);return}return r}registeExpressionGroup(t,e,r){this._expressionGroups[t]=r,e?this._expressionPresetMap[e]=t:this._unknownGroupNames.push(t)}getValue(t){var r;const e=this.getExpressionGroup(t);return(r=e==null?void 0:e.weight)!=null?r:null}setValue(t,e){const r=this.getExpressionGroup(t);r&&(r.weight=Math.max(Math.min(e,1),0))}getExpressionTrackName(t){const e=this.getExpressionGroup(t);return e?`${e.name}.weight`:null}update(){Object.keys(this._expressionGroups).forEach(t=>{this._expressionGroups[t].clearAppliedWeight()}),Object.keys(this._expressionGroups).forEach(t=>{this._expressionGroups[t].applyWeight()})}}class ${async import(t){var l;const e=(l=t.gltf.extensions)==null?void 0:l.VRM;if(!e)return null;const r=e.blendShapeMaster;if(!r)return null;const o=new G,a=r.blendShapeGroups;if(!a)return o;const s={};return await Promise.all(a.map(async c=>{const f=c.name;if(f===void 0){console.warn("VRMExpressionImporter: One of expressionGroups has no name");return}let u;c.presetName&&c.presetName!==h.VRMSchema.ExpressionPresetName.Unknown&&!s[c.presetName]&&(u=c.presetName,s[c.presetName]=f);const d=new j(f);d.isBinary=c.isBinary||!1,c.binds&&c.binds.forEach(async g=>{if(g.mesh===void 0||g.index===void 0)return;const _=[];t.gltf.nodes.forEach((b,L)=>{b.mesh===g.mesh&&_.push(L)});const x=g.index;await Promise.all(_.map(async b=>{var S;const L=await Y(t,b);if(!L.every(ht=>ht.morphTargetManager&&x<ht.morphTargetManager.numTargets)){console.warn(`ExpressionImporter: ${c.name} attempts to index ${x}th morph but not found.`);return}d.addBind({meshes:L,morphTargetIndex:x,weight:(S=g.weight)!=null?S:100})}))});const p=c.materialValues;p&&p.forEach(g=>{if(g.materialName===void 0||g.propertyName===void 0||g.targetValue===void 0)return;[].forEach(x=>{d.addMaterialValue({material:x,propertyName:_t(g.propertyName),targetValue:g.targetValue})})}),o.registeExpressionGroup(f,u,d)})),o}}const Mt=Object.freeze(new n.Vector3(0,0,-1)),q=new n.Quaternion;class V{static _parseFirstPersonFlag(t){switch(t){case"Both":return 1;case"ThirdPersonOnly":return 2;case"FirstPersonOnly":return 3;default:return 0}}constructor(t,e){this.firstPersonFlag=V._parseFirstPersonFlag(t),this.primitives=e,console.log("primitives:%O",e)}}const w=class{constructor(i,t,e){this._meshAnnotations=[],this._firstPersonOnlyLayer=w._DEFAULT_FIRSTPERSON_ONLY_LAYER,this._thirdPersonOnlyLayer=w._DEFAULT_THIRDPERSON_ONLY_LAYER,this._bothLayer=w._DEFAULT_BOTH_LAYER,this._initialized=!1,this._firstPersonBone=i,this._firstPersonBoneOffset=t,this._meshAnnotations=e}get firstPersonBone(){return this._firstPersonBone}get meshAnnotations(){return this._meshAnnotations}getFirstPersonWorldDirection(i){return this._firstPersonBone.getWorldMatrix().decompose(void 0,q),i.copyFrom(Mt),F(q,i,i),i}get firstPersonOnlyLayer(){return this._firstPersonOnlyLayer}get thirdPersonOnlyLayer(){return this._thirdPersonOnlyLayer}get bothLayer(){return this._bothLayer}getFirstPersonBoneOffset(i){return i.copyFrom(this._firstPersonBoneOffset)}getFirstPersonWorldPosition(i){const t=this._firstPersonBoneOffset,e=new n.Vector3(t.x,t.y,t.z);return e.copyFrom(n.Vector3.TransformCoordinates(e,this._firstPersonBone.getWorldMatrix())),i.set(e.x,e.y,e.z)}setup({firstPersonOnlyLayer:i=w._DEFAULT_FIRSTPERSON_ONLY_LAYER,thirdPersonOnlyLayer:t=w._DEFAULT_THIRDPERSON_ONLY_LAYER}={}){this._initialized||(this._initialized=!0,this._firstPersonOnlyLayer=i,this._thirdPersonOnlyLayer=t,this._meshAnnotations.forEach(e=>{e.firstPersonFlag===3?e.primitives.forEach(r=>{r.layerMask=this._firstPersonOnlyLayer}):e.firstPersonFlag===2?e.primitives.forEach(r=>{r.layerMask=this._firstPersonOnlyLayer}):e.firstPersonFlag===0&&this._createHeadlessModel(e.primitives)}))}_createHeadlessModel(i){i.forEach(t=>{if(t._isMesh){const e=t;this._createHeadlessModelForSkinnedMesh(e.parent,e)}else this._isEraseTarget(t)&&(t.layerMask=this._thirdPersonOnlyLayer)})}_createHeadlessModelForSkinnedMesh(i,t){var r;const e=new Set;if((r=t.skeleton)==null||r.bones.forEach(o=>{o.id===this._firstPersonBone.id&&this._addTargetFlag(o,e)}),console.log(e),!Array.from(e).length){t.layerMask=this._bothLayer;return}t.layerMask=this._thirdPersonOnlyLayer}_createErasedMesh(i,t){const e=new n.Mesh(`${i.name}(erase)`,...[,,],i.clone());e.material=i.material,e.name=`${i.name}(erase)`,e.layerMask=this._firstPersonOnlyLayer;const r=e.geometry,o=r.getVerticesData("matricesIndices"),a=[];for(let p=0;p<o.length;p+=4)a.push([o[p],o[p+1],o[p+2],o[p+3]]);const s=r.getVerticesData("matricesWeights"),l=[];for(let p=0;p<s.length;p+=4)l.push([s[p],s[p+1],s[p+2],s[p+3]]);const c=r.getIndices();if(!(c==null?void 0:c.length))throw new Error("The geometry doesn't have an index buffer");const f=Array.from(c),u=this._excludeTriangles(f,l,a,t),d=[];for(let p=0;p<u;p++)d[p]=f[p];return r.setIndices(d),i.onBeforeBindObservable,e}_excludeTriangles(i,t,e,r){let o=0;if(t!=null&&t.length>0)for(let a=0;a<i.length;a+=3){const s=i[a],l=i[a+1],c=i[a+2],f=t[s],u=e[s];if(f[0]>0&&r.includes(u[0])||f[1]>0&&r.includes(u[1])||f[2]>0&&r.includes(u[2])||f[3]>0&&r.includes(u[3]))continue;const d=t[l],p=e[l];if(d[0]>0&&r.includes(p[0])||d[1]>0&&r.includes(p[1])||d[2]>0&&r.includes(p[2])||d[3]>0&&r.includes(p[3]))continue;const g=t[c],_=e[c];g[0]>0&&r.includes(_[0])||g[1]>0&&r.includes(_[1])||g[2]>0&&r.includes(_[2])||g[3]>0&&r.includes(_[3])||(i[o++]=s,i[o++]=l,i[o++]=c)}return o}_isEraseTarget(i){return i===this._firstPersonBone?!0:i.parent?this._isEraseTarget(i.parent):!1}_addTargetFlag(i,t){if(!t.has(i.id)){t.add(i.id);for(let e=0;e<i.children.length;e++)this._addTargetFlag(i.children[e],t)}}};let R=w;R._DEFAULT_BOTH_LAYER=268435455,R._DEFAULT_FIRSTPERSON_ONLY_LAYER=268435456,R._DEFAULT_THIRDPERSON_ONLY_LAYER=536870912;class X{async import(t,e){var u;const r=(u=t.gltf.extensions)==null?void 0:u.VRM;if(!r)return null;const o=r.firstPerson;if(!o)return null;const a=o.firstPersonBone;let s;if(a===void 0||a===-1)s=e.getBoneNode(h.VRMSchema.HumanoidBoneName.Head);else{s=t.gltf.nodes[a]._babylonTransformNode;const d=await Y(t,a);console.log(d)}if(!s)return console.warn("FirstPersonImporter: Could not find firstPersonBone of the VRM"),null;const l=o.firstPersonBoneOffset?new n.Vector3(o.firstPersonBoneOffset.x,o.firstPersonBoneOffset.y,o.firstPersonBoneOffset.z):new n.Vector3(0,.06,0),c=[],f=await mt(t);return Array.from(f.entries()).forEach(([d,p])=>{const g=t.gltf.nodes[d],_=o.meshAnnotations?o.meshAnnotations.find(x=>x.mesh===g.mesh):void 0;c.push(new V(_==null?void 0:_.firstPersonFlag,p))}),new R(s,l,c)}}class J{constructor(t,e){this.node=t,this.humanLimit=e}}const v=new n.Vector3;let T=new n.Quaternion;class Z{constructor(t,e){this.restPose={},this.humanBones=this._createHumanBones(t),this.humanDescription=e,this.restPose=this.getPose()}getPose(){const t={};return Object.keys(this.humanBones).forEach(e=>{const r=this.getBoneNode(e);if(!r||t[e])return;v.set(0,0,0),T=n.Quaternion.Identity();const o=this.restPose[e];(o==null?void 0:o.position)&&v.fromArray(o.position).negate(),(o==null?void 0:o.rotation)&&(T=n.Quaternion.FromArray(o.rotation),n.Quaternion.InverseToRef(T,T)),v.add(r.position),T=r.rotationQuaternion.multiply(T),t[e]={position:v.asArray(),rotation:T.asArray()}},{}),t}setPose(t){Object.keys(t).forEach(e=>{const r=t[e],o=this.getBoneNode(e);if(!o)return;const a=this.restPose[e];!a||(r.position&&(o.position.fromArray(r.position),a.position&&o.position.add(v.fromArray(a.position))),r.rotation&&(o.rotationQuaternion=n.Quaternion.FromArray(r.rotation),a.rotation&&(T=n.Quaternion.FromArray(a.rotation),o.rotationQuaternion.multiply(T))))})}resetPose(){Object.entries(this.restPose).forEach(([t,e])=>{const r=this.getBoneNode(t);!r||((e==null?void 0:e.position)&&r.position.fromArray(e.position),(e==null?void 0:e.rotation)&&(r.rotationQuaternion=n.Quaternion.FromArray(e.rotation)))})}getBone(t){var e;return(e=this.humanBones[t][0])!=null?e:void 0}getBones(t){var e;return(e=this.humanBones[t])!=null?e:[]}getBoneNode(t){var e,r;return(r=(e=this.humanBones[t][0])==null?void 0:e.node)!=null?r:null}getBoneNodes(t){var e,r;return(r=(e=this.humanBones[t])==null?void 0:e.map(o=>o.node))!=null?r:[]}_createHumanBones(t){const e=Object.values(h.VRMSchema.HumanoidBoneName).reduce((r,o)=>(r[o]=[],r),{});return t.forEach(r=>{e[r.name].push(r.bone)}),e}}class K{async import(t){var s;const e=(s=t.gltf.extensions)==null?void 0:s.VRM;if(!e)return null;const r=e.humanoid;if(!r)return null;const o=[];r.humanBones&&await Promise.all(r.humanBones.map(async l=>{if(!l.bone||l.node==null)return;const c=t.babylonScene.transformNodes[l.node];o.push({name:l.bone,bone:new J(c,{axisLength:l.axisLength,center:l.center&&new n.Vector3(l.center.x,l.center.y,l.center.z),max:l.max&&new n.Vector3(l.max.x,l.max.y,l.max.z),min:l.min&&new n.Vector3(l.min.x,l.min.y,l.min.z),useDefaultValues:l.useDefaultValues})})}));const a={armStretch:r.armStretch,legStretch:r.legStretch,upperArmTwist:r.upperArmTwist,lowerArmTwist:r.lowerArmTwist,upperLegTwist:r.upperLegTwist,lowerLegTwist:r.lowerLegTwist,feetSpacing:r.feetSpacing,hasTranslationDoF:r.hasTranslationDoF};return new Z(o,a)}}const Lt=(i,t,e,r,o)=>{const a=o*o*o,s=o*o,l=t-i,c=-2*a+3*s,f=a-2*s+o,u=a-s;return i+l*c+e*f+r*u},Rt=(i,t)=>{if(i.length<8)throw new Error("evaluateCurve: Invalid curve detected! (Array length must be 8 at least)");if(i.length%4!==0)throw new Error("evaluateCurve: Invalid curve detected! (Array length must be multiples of 4");let e;for(e=0;;e++){if(i.length<=4*e)return i[4*e-3];if(t<=i[4*e])break}const r=e-1;if(r<0)return i[4*r+5];const o=i[4*r],a=i[4*e],s=(t-o)/(a-o),l=i[4*r+1],c=i[4*e+1],f=i[4*r+3],u=i[4*e+2];return Lt(l,c,f,u,s)};class k{constructor(t,e,r){this.curve=[0,0,0,1,1,1,1,0],this.curveXRangeDegree=90,this.curveYRangeDegree=10,t!==void 0&&(this.curveXRangeDegree=t),e!==void 0&&(this.curveYRangeDegree=e),r!==void 0&&(this.curve=r)}map(t){const r=Math.min(Math.max(t,0),this.curveXRangeDegree)/this.curveXRangeDegree;return this.curveYRangeDegree*Rt(this.curve,r)}}class D{}class H extends D{constructor(t,e,r,o){super();this.type=h.VRMSchema.FirstPersonLookAtTypeName.Expression,this._curveHorizontal=e,this._curveVerticalDown=r,this._curveVerticalUp=o,this._expressionProxy=t}name(){return h.VRMSchema.FirstPersonLookAtTypeName.Expression}lookAt(t){const e=t.x,r=t.y;e<0?(this._expressionProxy.setValue(h.VRMSchema.ExpressionPresetName.Lookup,0),this._expressionProxy.setValue(h.VRMSchema.ExpressionPresetName.Lookdown,this._curveVerticalDown.map(-e))):(this._expressionProxy.setValue(h.VRMSchema.ExpressionPresetName.Lookdown,0),this._expressionProxy.setValue(h.VRMSchema.ExpressionPresetName.Lookup,this._curveVerticalUp.map(e))),r<0?(this._expressionProxy.setValue(h.VRMSchema.ExpressionPresetName.Lookleft,0),this._expressionProxy.setValue(h.VRMSchema.ExpressionPresetName.Lookright,this._curveHorizontal.map(-r))):(this._expressionProxy.setValue(h.VRMSchema.ExpressionPresetName.Lookright,0),this._expressionProxy.setValue(h.VRMSchema.ExpressionPresetName.Lookleft,this._curveHorizontal.map(r)))}}const m=new n.Vector3(0,0,0);class tt extends D{constructor(t,e,r,o,a){super();this.type=h.VRMSchema.FirstPersonLookAtTypeName.Bone,this._curveHorizontalInner=e,this._curveHorizontalOuter=r,this._curveVerticalDown=o,this._curveVerticalUp=a,this._leftEye=t.getBoneNode(h.VRMSchema.HumanoidBoneName.LeftEye),this._rightEye=t.getBoneNode(h.VRMSchema.HumanoidBoneName.RightEye)}lookAt(t){const e=t.x,r=t.y;this._leftEye&&(e<0?m.x=-this._curveVerticalDown.map(-e):m.x=this._curveVerticalUp.map(e),r<0?m.y=-this._curveHorizontalInner.map(-r):m.y=this._curveHorizontalOuter.map(r),this._leftEye.rotationQuaternion=n.Quaternion.FromEulerAngles(m.x,m.y,m.z)),this._rightEye&&(e<0?m.x=-this._curveVerticalDown.map(-e):m.x=this._curveVerticalUp.map(e),r<0?m.y=-this._curveHorizontalOuter.map(-r):m.y=this._curveHorizontalInner.map(r),this._rightEye.rotationQuaternion=n.Quaternion.FromEulerAngles(m.x,m.y,m.z))}}const vt=Object.freeze(new n.Vector3(0,0,-1)),et=new n.Vector3,At=new n.Vector3,bt=new n.Vector3,M=new n.Quaternion;class O{constructor(t,e){this.autoUpdate=!0,this._euler=new n.Vector3(0,0,0),this.firstPerson=t,this.applyer=e}getLookAtWorldDirection(t){this.firstPerson.firstPersonBone.getWorldMatrix().decompose(void 0,M);const e=n.Quaternion.FromEulerVector(this._euler);return F(e,t.copyFrom(vt),t),F(M,t,t),t}lookAt(t){this._calcEuler(this._euler,t),this.applyer&&this.applyer.lookAt(this._euler)}update(t){t<=0||this.target&&this.autoUpdate&&(et.copyFrom(this.target.getAbsolutePosition()),this.lookAt(et),this.applyer&&this.applyer.lookAt(this._euler))}_calcEuler(t,e){const r=this.firstPerson.getFirstPersonWorldPosition(At),o=bt.copyFrom(e).subtract(r).normalize();return this.firstPerson.firstPersonBone.getWorldMatrix().decompose(void 0,M),n.Quaternion.InverseToRef(M,M),F(M,o,o),t.x=Math.atan2(o.y,Math.sqrt(o.x*o.x+o.z*o.z)),t.y=Math.atan2(-o.x,-o.z),t}}O.EULER_ORDER="YXZ";const z=Math.PI/180;class rt{import(t,e,r,o){var c;const a=(c=t.gltf.extensions)==null?void 0:c.VRM;if(!a)return null;const s=a.firstPerson;if(!s)return null;const l=this._importApplyer(s,r,o);return new O(e,l||void 0)}_importApplyer(t,e,r){const o=t.lookAtHorizontalInner,a=t.lookAtHorizontalOuter,s=t.lookAtVerticalDown,l=t.lookAtVerticalUp;switch(t.lookAtTypeName){case h.VRMSchema.FirstPersonLookAtTypeName.Bone:return o===void 0||a===void 0||s===void 0||l===void 0?null:new tt(r,this._importCurveMapperBone(o),this._importCurveMapperBone(a),this._importCurveMapperBone(s),this._importCurveMapperBone(l));case h.VRMSchema.FirstPersonLookAtTypeName.Expression:return a===void 0||s===void 0||l===void 0?null:new H(e,this._importCurveMapperExpression(a),this._importCurveMapperExpression(s),this._importCurveMapperExpression(l));default:return null}}_importCurveMapperBone(t){return new k(typeof t.xRange=="number"?z*t.xRange:void 0,typeof t.yRange=="number"?z*t.yRange:void 0,t.curve)}_importCurveMapperExpression(t){return new k(typeof t.xRange=="number"?z*t.xRange:void 0,t.yRange,t.curve)}}class Et{constructor(t){var e;this.ignoreTexture=(e=t==null?void 0:t.ignoreTexture)!=null?e:!1}async import(t){var o;const e=(o=t.gltf.extensions)==null?void 0:o.VRM;if(!e)return null;const r=e.meta;return r?{allowedUserName:r.allowedUserName,author:r.author,commercialUssageName:r.commercialUssageName,contactInformation:r.contactInformation,licenseName:r.licenseName,otherLicenseUrl:r.otherLicenseUrl,otherPermissionUrl:r.otherPermissionUrl,reference:r.reference,sexualUssageName:r.sexualUssageName,texture:r.texture,title:r.title,version:r.version,violentUssageName:r.violentUssageName}:null}}class ot{constructor(t,e){this.colliderGroups=[],this.springBoneGroupList=[],this.colliderGroups=t,this.springBoneGroupList=e}setCenter(t){this.springBoneGroupList.forEach(e=>{e.forEach(r=>{r.center=t})})}lateUpdate(t){this.springBoneGroupList.forEach(e=>{e.forEach(r=>{r.update(t)})})}reset(){this.springBoneGroupList.forEach(t=>{t.forEach(e=>{e.reset()})})}}const Ft=Object.freeze(new n.Quaternion),B=new n.Vector3,I=new n.Vector3,it=new n.Vector3,st=new n.Quaternion,y=new n.Matrix,A=new n.Matrix;class nt{constructor(t,e={}){var o,a,s,l,c,f;if(this._currentTail=new n.Vector3,this._prevTail=new n.Vector3,this._nextTail=new n.Vector3,this._boneAxis=new n.Vector3,this._centerSpacePosition=new n.Vector3,this._center=null,this._parentWorldRotation=new n.Quaternion,this._initialLocalMatrix=new n.Matrix,this._initialLocalRotation=new n.Quaternion,this._initialLocalChildPosition=new n.Vector3,this.bone=t,this.radius=(o=e.radius)!=null?o:.02,this.stiffnessForce=(a=e.stiffnessForce)!=null?a:1,this.gravityDir=e.gravityDir?new n.Vector3().copyFrom(e.gravityDir):new n.Vector3().set(0,-1,0),this.gravityPower=(s=e.gravityPower)!=null?s:0,this.dragForce=(l=e.dragForce)!=null?l:.4,this.colliders=(c=e.colliders)!=null?c:[],this.bone.getWorldMatrix().getTranslationToRef(this._centerSpacePosition),this._initialLocalMatrix.copyFrom(this.bone._localMatrix),this._initialLocalRotation.copyFrom(this.bone.rotationQuaternion),this.bone.getChildren().length===0)this._initialLocalChildPosition.copyFrom(this.bone.position).normalize().scaleToRef(.07,this._initialLocalChildPosition);else{const u=this.bone.getChildTransformNodes()[0];this._initialLocalChildPosition.copyFrom(u.position)}n.Vector3.TransformCoordinatesToRef(this._initialLocalChildPosition,this.bone.getWorldMatrix(),this._currentTail),this._prevTail.copyFrom(this._currentTail),this._nextTail.copyFrom(this._currentTail),this._boneAxis.copyFrom(this._initialLocalChildPosition).normalize(),this._centerSpaceBoneLength=n.Vector3.TransformCoordinates(this._initialLocalChildPosition,this.bone.getWorldMatrix()).subtract(this._centerSpacePosition).length(),this.center=(f=e.center)!=null?f:null}get center(){return this._center}set center(t){this._getMatrixCenterToWorld(y),n.Vector3.TransformCoordinatesToRef(this._currentTail,y,this._currentTail),n.Vector3.TransformCoordinatesToRef(this._prevTail,y,this._prevTail),n.Vector3.TransformCoordinatesToRef(this._nextTail,y,this._nextTail),this._center=t,this._getMatrixWorldToCenter(y),n.Vector3.TransformCoordinatesToRef(this._currentTail,y,this._currentTail),n.Vector3.TransformCoordinatesToRef(this._prevTail,y,this._prevTail),n.Vector3.TransformCoordinatesToRef(this._nextTail,y,this._nextTail),this.bone.getWorldMatrix().multiplyToRef(y,y),y.getTranslationToRef(this._centerSpacePosition),this._centerSpaceBoneLength=n.Vector3.TransformCoordinates(this._initialLocalChildPosition,y).subtract(this._centerSpacePosition).length()}reset(){var t,e;(e=(t=this.bone)==null?void 0:t.rotationQuaternion)==null||e.copyFrom(this._initialLocalRotation),P.Matrix.ComposeToRef(this.bone.scaling,this.bone.rotationQuaternion,this.bone.position,this.bone._localMatrix),this.bone.freezeWorldMatrix(this.bone._localMatrix.multiply(this._getParentMatrixWorld())),this.bone.getWorldMatrix().getTranslationToRef(this._centerSpacePosition),n.Vector3.TransformCoordinatesToRef(this._initialLocalChildPosition,this.bone.getWorldMatrix(),this._currentTail),this._prevTail.copyFrom(this._currentTail),this._nextTail.copyFrom(this._currentTail)}update(t){if(t<=0)return;this.bone.freezeWorldMatrix(this.bone._localMatrix.multiply(this._getParentMatrixWorld())),this.bone.parent?this.bone.parent.getWorldMatrix().decompose(void 0,this._parentWorldRotation):this._parentWorldRotation.copyFrom(Ft),this._getMatrixWorldToCenter(y),this.bone.getWorldMatrix().multiplyToRef(y,y),y.getTranslationToRef(this._centerSpacePosition),this._getMatrixWorldToCenter(A),this._getParentMatrixWorld().multiplyToRef(A,A);const e=this.stiffnessForce*t,r=I.copyFrom(this.gravityDir).scaleToRef(this.gravityPower*t,I),o=new n.Vector3,a=new n.Vector3;n.Vector3.TransformCoordinatesToRef(n.Vector3.TransformCoordinates(this._boneAxis,this._initialLocalMatrix),A,o),o.subtractToRef(this._centerSpacePosition,o),o.normalize().scaleToRef(e,o),a.copyFrom(this._currentTail).subtractToRef(this._prevTail,a),a.scaleToRef(1-this.dragForce,a),this._nextTail.copyFrom(this._currentTail).addToRef(a,this._nextTail),this._nextTail.addToRef(o,this._nextTail),this._nextTail.addToRef(r,this._nextTail),this._nextTail.subtractToRef(this._centerSpacePosition,this._nextTail),this._nextTail.normalize(),this._nextTail.scaleToRef(this._centerSpaceBoneLength,this._nextTail),this._nextTail.addToRef(this._centerSpacePosition,this._nextTail),this._collision(this._nextTail),this._prevTail.copyFrom(this._currentTail),this._currentTail.copyFrom(this._nextTail);const s=new n.Matrix;y.copyFrom(this._initialLocalMatrix.multiply(A)),y.invertToRef(s),dt(this._boneAxis,n.Vector3.TransformCoordinates(B.copyFrom(this._nextTail),s).normalize(),st),st.multiplyToRef(this._initialLocalRotation,this.bone.rotationQuaternion),P.Matrix.ComposeToRef(this.bone.scaling,this.bone.rotationQuaternion,this.bone.position,this.bone._localMatrix),this.bone.freezeWorldMatrix(this.bone._localMatrix.multiply(this._getParentMatrixWorld()))}_collision(t){this.colliders.forEach(e=>{this._getMatrixWorldToCenter(y),y.multiplyToRef(e.getWorldMatrix(),y),y.getTranslationToRef(B);const r=B,o=e.getBoundingInfo().boundingSphere.radius,a=this.radius+o;if(n.Vector3.DistanceSquared(t,r)<=a*a){t.subtractToRef(r,I);const s=I.normalize();s.scaleToRef(a,s),r.addToRef(s,it);const l=it;l.subtractToRef(this._centerSpacePosition,l),l.normalize(),l.scaleToRef(this._centerSpaceBoneLength,l),l.addToRef(this._centerSpacePosition,l),t.copyFrom(l)}})}_getMatrixCenterToWorld(t){return this._center?t.copyFrom(this._center.getWorldMatrix()):t.copyFrom(n.Matrix.Identity()),t}_getMatrixWorldToCenter(t){return this._center?this._center.getWorldMatrix().invertToRef(t):t.copyFrom(n.Matrix.Identity()),t}_getParentMatrixWorld(){return this.bone.parent?this.bone.parent.getWorldMatrix():n.Matrix.Identity()}}const Vt=new n.Vector3;class at{async import(t){var s;const e=(s=t.gltf.extensions)==null?void 0:s.VRM;if(!e)return null;const r=e.secondaryAnimation;if(!r)return null;const o=await this._importColliderMeshGroups(t,r),a=await this._importSpringBoneGroupList(t,r,o);return new ot(o,a)}_createSpringBone(t,e={}){return new nt(t,e)}async _importSpringBoneGroupList(t,e,r){const o=e.boneGroups||[],a=[];return await Promise.all(o.map(async s=>{if(s.stiffiness===void 0||s.gravityDir===void 0||s.gravityDir.x===void 0||s.gravityDir.y===void 0||s.gravityDir.z===void 0||s.gravityPower===void 0||s.dragForce===void 0||s.hitRadius===void 0||s.colliderGroups===void 0||s.bones===void 0||s.center===void 0)return;const l=s.stiffiness,c=new n.Vector3(s.gravityDir.x,s.gravityDir.y,s.gravityDir.z),f=s.gravityPower,u=s.dragForce,d=s.hitRadius,p=[];s.colliderGroups.forEach(_=>{p.push(...r[_].colliders)});const g=[];await Promise.all(s.bones.map(async _=>{const x=t.babylonScene.transformNodes[_],b=s.center!==-1?t.babylonScene.transformNodes[s.center]:null;!x||E(x,L=>{const S=this._createSpringBone(L,{radius:d,stiffnessForce:l,gravityDir:c,gravityPower:f,dragForce:u,colliders:p,center:b});g.push(S)})})),a.push(g)})),a}async _importColliderMeshGroups(t,e){const r=e.colliderGroups;if(r===void 0)return[];const o=[];return r.forEach(async a=>{if(a.node===void 0||a.colliders===void 0)return;const s=t.babylonScene.transformNodes[a.node],l=[];a.colliders.forEach(f=>{if(f.offset===void 0||f.offset.x===void 0||f.offset.y===void 0||f.offset.z===void 0||f.radius===void 0)return;const u=Vt.set(f.offset.x,f.offset.y,f.offset.z),d=this._createColliderMesh(f.radius,u,t.babylonScene);d.setParent(s),l.push(d)});const c={node:a.node,colliders:l};o.push(c)}),o}_createColliderMesh(t,e,r){new n.Material("collider",r);const o=n.MeshBuilder.CreateSphere("collider",{segments:32,diameter:2*t});return o.visibility=0,o.position.copyFrom(e),o.name="vrmColliderSphere",o.getBoundingInfo().boundingSphere.scale(1/3),o}}class lt{constructor(t={}){this._metaImporter=t.metaImporter||new Et,this._expressionImporter=t.expressionImporter||new $,this._lookAtImporter=t.lookAtImporter||new rt,this._humanoidImporter=t.humanoidImporter||new K,this._firstPersonImporter=t.firstPersonImporter||new X,this._springBoneImporter=t.springBoneImporter||new at}async import(t){if(t.gltf.extensions===void 0||t.gltf.extensions.VRM===void 0)throw new Error("Could not find VRM extension on the GLTF");const e=await this._metaImporter.import(t)||void 0,r=await this._humanoidImporter.import(t)||void 0,o=r&&await this._firstPersonImporter.import(t,r)||void 0,a=await this._expressionImporter.import(t)||void 0,s=o&&a&&r&&await this._lookAtImporter.import(t,o,a,r)||void 0,l=await this._springBoneImporter.import(t)||void 0;return new U({scene:t.babylonScene,meta:e,humanoid:r,firstPerson:o,expressionProxy:a,lookAt:s,springBoneManager:l})}}class U{static async from(t,e={}){return await new lt(e).import(t)}constructor(t){this.scene=t.scene,this.humanoid=t.humanoid,this.expressionProxy=t.expressionProxy,this.firstPerson=t.firstPerson,this.lookAt=t.lookAt,this.materials=t.materials,this.springBoneManager=t.springBoneManager,this.meta=t.meta}update(t){this.lookAt&&this.lookAt.update(t),this.expressionProxy&&this.expressionProxy.update(),this.springBoneManager&&this.springBoneManager.lateUpdate(t),this.materials&&this.materials.forEach(e=>{e.updateVRMMaterials&&e.updateVRMMaterials(t)})}dispose(){const t=this.scene;t&&t.rootNodes.forEach(e=>yt(e))}}class C extends pt.GLTFFileLoader{constructor(){super(...arguments);this.name="vrm",this.extensions={".vrm":{isBinary:!0}}}createPlugin(){return new C}}const W="VRM";class ct{constructor(t){this.loader=t,this.name=W,this.enabled=!0,this.meshesFrom=0,this.transformNodesFrom=0,this.meshesFrom=this.loader.babylonScene.meshes.length-1,this.transformNodesFrom=this.loader.babylonScene.transformNodes.length}dispose(){this.loader=null}onReady(){if(!this.loader.gltf.extensions||!this.loader.gltf.extensions[W])return;const t=this.loader.babylonScene;U.from(this.loader).then(e=>{t.metadata=t.metadata||{},t.metadata.vrm=t.metadata.vrm||[],t.metadata.vrm.push(e),this.loader.babylonScene.onDisposeObservable.add(()=>{e.dispose(),this.loader.babylonScene.metadata.vrm=[]})})}}ft.GLTFLoader.RegisterExtension(W,i=>new ct(i)),n.SceneLoader&&n.SceneLoader.RegisterPlugin(new C),h.CurveMapper=k,h.ExpressionGroup=j,h.ExpressionImporter=$,h.ExpressionProxy=G,h.FirstPerson=R,h.FirstPersonImporter=X,h.HumanBone=J,h.Humanoid=Z,h.HumanoidImporter=K,h.Importer=lt,h.LookAtApplyer=D,h.LookAtBoneApplyer=tt,h.LookAtExpressionApplyer=H,h.LookAtHead=O,h.LookAtImporter=rt,h.RendererFirstPersonFlags=V,h.SpringBone=nt,h.SpringBoneImporter=at,h.SpringBoneManager=ot,h.VRM=U,h.VRMExtensionLoader=ct,h.VRMFileLoader=C,Object.defineProperty(h,"__esModule",{value:!0}),h[Symbol.toStringTag]="Module"});
